<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<div id="header" class="header-print">
    <div class="headerContainer">
       <ul id="logo">
          <li>
             <div class="servicehub_logo"></div>
             <div>
                <p>
                   <span id="app_title" class="app-header-label" style="padding-top: 23px;font-weight: normal;">Actionable Insights</span>
                </p>
             </div>
          </li>
       </ul>
       <div class="header-right">
          <div class="logoutDropdown">
             <button class="user" (click)="showLogout()">
                <div class="col-xs-2 dvuserprofile_logo">
                   <div class="userprofile_logo"></div>
                </div>
                <div class="col-xs-10 userprofile_name">
                   <span id="logged-in_username" class="userName">{{currentLoggedInUserDisplayName}}</span>
                </div>
             </button>
             <div class="dropdown-content" *ngIf="currDiv == true">
                <div style="background-color: var(--bax-blue); height: 64px;">
                </div>
                <div class="logout" id="dvLogout">
                   <a id='logout' (click)="logout()">Log out</a>
                </div>
             </div>
          </div>
       </div>
        <div class="loadingContainer" style="z-index: -900;">
          <div id="spinner">
             <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          </div>
       </div>
       </div>
  <div *ngIf="notificationsList.length > 0" id="notification_bar" class="col-xs-12 notifications">
     <div class="col-xs-12 notify-container" *ngFor="let item of notificationsList; let i=index">
        <div class="col-xs-11 content">
           <div class="errorImage col-xs-1"></div>
           <div class="col-xs-11 errorLabel"><b>{{item.label}} </b></div></div>
        <div class="col-xs-1 buttoncontent">
           <button (click) = "openNotificationPopup(item)" class="btn-more bax_button_primary_secondary">MORE...</button></div>
     </div>
  </div>
 </div>
 

      <div [hidden] ="!powerBIError" class = "errorMessageContainer">
         <span class ="errorMessage" id ="errorText">There was a problem loading Actionable Insights.</span>
         <span class ="errorMessage" id = "errorSubText">Please contact Technical Support.</span>

      </div>      


   <div [hidden] ="powerBIError" class ="device-items" id = "device-items">
      <div [hidden]="powerBIError"class="powerbi-container" #powerbiContainer ></div>
  </div>

<!-- Floating Chat Widget -->
<div class="floating-chat-widget">
  <button class="chat-fab" (click)="toggleChat()">
    <i class="fas fa-robot"></i>
  </button>
  <div class="chat-card" *ngIf="isChatOpen">
    <div class="chat-card-header">
      <span>RAM Assistant</span>
      <button class="close-btn" (click)="toggleChat()">Ã—</button>
    </div>
    <div class="predefined-questions" *ngIf="showPredefinedQuestions">
      <div *ngFor="let group of predefinedQuestions">
        <div class="category-title">{{ group.category }}</div>
        <div class="question-list">
          <button *ngFor="let q of group.questions" (click)="sendPredefinedQuestion(q)">
            {{ q }}
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="!showPredefinedQuestions">
      <button class="back-btn" (click)="goBackToPredefinedQuestions()">
        <i class="fas fa-arrow-left"></i>
      </button>
    </div>
    <div class="chat-card-messages" #chatMessagesContainer>
      <div *ngFor="let message of chatMessages" class="message" [ngClass]="message.type">
        <div *ngIf="message.type === 'user'">{{message.content}}</div>
        <div *ngIf="message.type === 'bot'" [innerHTML]="message.html || message.content"></div>
      </div>
    </div>
    <div class="chat-card-input">
      <input type="text" [(ngModel)]="userMessage" placeholder="Type your message..." (keyup.enter)="sendMessage()">
      <button (click)="sendMessage()" title="Send">
        <i class="fas fa-paper-plane"></i>
      </button>
      <button class="mic-btn" [class.listening]="isListening" (click)="toggleVoiceRecognition()" title="Speak your message">
        <i class="fas fa-microphone"></i>
      </button>
    </div>
  </div>
</div>

<style>
.floating-chat-widget {
  position: fixed;
  bottom: 30px;
  right: 30px;
  z-index: 2000;

  .chat-fab {
    width: 60px;
    height: 60px;
    background: #2563eb;
    border: none;
    border-radius: 50%;
    color: #fff;
    font-size: 28px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: box-shadow 0.2s, transform 0.2s;
    &:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,0.22);
      transform: scale(1.08);
    }
  }

  .chat-card {
    position: absolute;
    bottom: 25px;
    right: 0;
    height: 740px;
    width: 800px;
    
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.18);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.3s cubic-bezier(.4,0,.2,1);

    .chat-card-header {
      height: 60px;
      background: #090a66;
      color: #fff;
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 18px;
      font-weight: 600;
      .close-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 24px;
        cursor: pointer;
        opacity: 0.8;
        &:hover { opacity: 1; }
      }
    }

    .chat-card-messages {
      flex: 1;
      padding: 18px;
      overflow-y: auto;
      background: #ffffff;
      .message {
        margin-bottom: 12px;
        padding: 10px 16px;
        border-radius: 14px;
        max-width: 95%;
        font-size: 16px;
        &.bot {
          background: #c5c7c9;
          border: 1px solid #e5e7eb;
          color: #222;
          margin-right: auto;

          
        }
        &.user {
          background: #4f77cd;
          color: #fff;
          margin-left: auto;
          margin-right: auto;
        }
      }
    }

    .chat-card-input {
      display: flex;
      align-items: center;
      padding: 14px;
      background: #fff;
      border-top: 1px solid #e5e7eb;
      input {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        padding: 10px 16px;
        font-size: 15px;
        outline: none;
        margin-right: 8px;
        &:focus { border-color: #2563eb; }
      }
      button {
        background: #2563eb;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        transition: background 0.2s;
        &:hover { background: #1e40af; }
      }
      .mic-btn {
        margin-left: 8px;
        background: #fff;
        color: #2563eb;
        border: 2px solid #2563eb;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        transition: box-shadow 0.2s, border-color 0.2s, color 0.2s;
        position: relative;
      }
      .mic-btn.listening {
        color: #fff;
        background: #e11d48;
        border-color: #e11d48;
        box-shadow: 0 0 0 4px rgba(225,29,72,0.15), 0 0 12px 2px #e11d48;
        animation: pulse-mic 1s infinite;
      }
      @keyframes pulse-mic {
        0% { box-shadow: 0 0 0 4px rgba(225,29,72,0.15), 0 0 12px 2px #e11d48; }
        50% { box-shadow: 0 0 0 10px rgba(225,29,72,0.10), 0 0 24px 4px #e11d48; }
        100% { box-shadow: 0 0 0 4px rgba(225,29,72,0.15), 0 0 12px 2px #e11d48; }
      }
    }

    .predefined-questions {
      padding: 12px 18px 0 18px;
      .category-title {
        font-weight: bold;
        margin-top: 10px;
        margin-bottom: 6px;
        font-size: 14px;
      }
      .question-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 10px;
        margin-bottom: 8px;
        button {
          background: #e5e7eb;
          border: none;
          border-radius: 16px;
          padding: 7px 16px;
          font-size: 14px;
          color: #222;
          cursor: pointer;
          transition: background 0.2s;
          &:hover {
            background: #d1d5db;
          }
        }
      }
    }
  }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(40px);}
  to { opacity: 1; transform: translateY(0);}
}
</style>
